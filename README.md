## RobustPentestMacro

This is a rich-featured Visual Basic macro code for use during Penetration Testing assignments, implementing various advanced post-exploitation techniques like sandbox evasion, WMI persistence and page substitution.

Created to make it possibly to simply _Paste Payload then Copy & Paste entire macro_ into phished document.

For list of example Macro generation and usage scenarios one can check out author's gist here:

[Various-Macro-Based-RCEs.md](https://gist.github.com/mgeeky/9dee0ac86c65cdd9cb5a2f64cef51991)


---

### SYNOPSIS:

This is a skeleton code for the malicious Macro that could
be used during Penetration Testing assignments (or for education
purposes), in order to embed it within Phishing documents as a
Microsoft Office macro.

There are following features implemented:

- **Sandbox detection** - allowing to exit macro when being scanned

- **WMI Subscription persistence** - allowing to survive system restart

- **Page substitution** - for hiding fake "Enable Content" warning.
    In order to leverage this feature, one has to prepare a fake "Enable Content" warning message
    like for instance Microsoft Office compatibility issues, AV scanned flag or something imaginary,
    and then to put entire real document contents in document's AutoText named by default `RealDoc`.
    `(Office Ribbon -> INSERT -> Quick Parts -> Add AutoText...)`

- **Supporting both MSWORD and EXCEL startup routines**


> One should definitely feed this script into some kind of 
> Visual Basic obfuscator, like the author's one:
>	[VisualBasicObfuscator](https://github.com/mgeeky/VisualBasicObfuscator)

The macro's code has been built up from other author's building blocks:
- [WMIPersistence.vbs](https://gist.github.com/mgeeky/d00ba855d2af73fd8d7446df0f64c25a)
- [MacroDetectSandbox.vbs](https://gist.github.com/mgeeky/61e4dfe305ab719e9874ca442779a91d)
- [SubstitutePageMacro.vbs](https://gist.github.com/mgeeky/3c705560c5041ab20c62f41e917616e6)


---

### CONFIGURATION

The most essential configuration here is the `EXECUTE_COMMAND` variable
that has to contain a command to be launched upon execution. This
command can be for instance `"powershell -noP -sta -w 1 -enc <code>"` payload

Further options are documented within code's CONFIGURATION section and are self-explanatory.


---

### DISCALIMER:

The author of this code is not taking any responsibilities of
any illegal usage of it. The code had been created solely for 
Penetration Testing purposes.

---

### AUTHOR:

    Mariusz B. / mgeeky, '17
    Shared on GPL license.
